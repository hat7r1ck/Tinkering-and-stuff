import pandas as pd
import yaml

# File paths
detections_yml_path = "detections.yml"  # Path to the detections YAML file
stories_yml_path = "stories.yml"        # Path to the stories YAML file
mitre_csv_path = "mitre_data.csv"       # Path to the MITRE mapping CSV
output_file = "mapped_stories.xlsx"     # Output Excel file path

# Load Detections YAML
with open(detections_yml_path, 'r') as f:
    detections_data = yaml.safe_load(f)

# Convert Detections YAML to DataFrame
detections_list = []
for detection in detections_data:
    detections_list.append({
        "Detection Name": detection.get("name", ""),
        "Data Sources": "|".join(detection.get("data_source", [])),  # Combine data sources
        "Tactics": "|".join(detection.get("tags", {}).get("tactic", [])),  # Combine tactics
        "MITRE IDs": "|".join(detection.get("tags", {}).get("mitre_attack_id", []))  # Combine MITRE IDs
    })
detections_df = pd.DataFrame(detections_list)

# Load Stories YAML
with open(stories_yml_path, 'r') as f:
    stories_data = yaml.safe_load(f)

# Convert Stories YAML to DataFrame
stories_list = []
for story in stories_data:
    stories_list.append({
        "Story Name": story.get("name", ""),
        "Detections": story.get("detections", []),  # List of detections
        "Products": "|".join(story.get("products", [])),  # Combine products
        "Date": story.get("date", "")
    })
stories_df = pd.DataFrame(stories_list)

# Load MITRE Data
mitre_df = pd.read_csv(mitre_csv_path)

# Create a mapping of MITRE IDs to tactics from the CSV
mitre_mapping = {}
for _, row in mitre_df.iterrows():
    mitre_mapping[row["mitre_attack_id"]] = {
        "tactic": row["tactic"],
        "technique": row["technique"]
    }

# Map Stories to Detections and Enrich with MITRE Data
mapped_data = []
for _, story in stories_df.iterrows():
    story_name = story["Story Name"]
    products = story["Products"]
    date = story["Date"]
    for detection_name in story["Detections"]:
        matched_detection = detections_df[detections_df["Detection Name"] == detection_name]
        if not matched_detection.empty:
            for _, detection_row in matched_detection.iterrows():
                # Enrich with MITRE tactics
                mitre_details = []
                for mitre_id in detection_row["MITRE IDs"].split('|'):
                    if mitre_id in mitre_mapping:
                        mitre_details.append(mitre_mapping[mitre_id]["tactic"])

                # Combine all details into the final row
                mapped_data.append({
                    "Story Name": story_name,
                    "Data Sources": detection_row["Data Sources"],
                    "Tactics": detection_row["Tactics"],
                    "Products": products,
                    "Date": date,
                    "MITRE Tactics": "|".join(set(mitre_details))  # Unique tactics combined with pipe
                })

# Convert to DataFrame
final_df = pd.DataFrame(mapped_data)

# Save to Excel
final_df.to_excel(output_file, index=False)
print(f"Data successfully saved to {output_file}")
